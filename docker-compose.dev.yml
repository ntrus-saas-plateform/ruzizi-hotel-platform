version: '3.8'

services:
  # MongoDB local pour développement (optionnel)
  mongodb-dev:
    image: mongo:7.0
    container_name: ruzizi-mongodb-dev
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-password123}
      MONGO_INITDB_DATABASE: ${MONGO_DB_NAME:-ruzizi_hotel_dev}
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongodb_dev_data:/data/db
      - mongodb_dev_config:/data/configdb
    networks:
      - ruzizi-dev-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - local-db

  # Application en mode développement
  app-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: development
    container_name: ruzizi-app-dev
    restart: unless-stopped
    environment:
      # Base de données (Atlas ou local)
      MONGODB_URI: ${MONGODB_URI:-mongodb://admin:password123@mongodb-dev:27017/ruzizi_hotel_dev?authSource=admin}
      
      # Configuration de développement
      NODE_ENV: development
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-dev-secret-key}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      
      # Configuration de l'utilisateur root
      ROOT_USER_EMAIL: ${ROOT_USER_EMAIL:-admin@ruzizihotel.com}
      ROOT_USER_FIRSTNAME: ${ROOT_USER_FIRSTNAME:-Administrateur}
      ROOT_USER_LASTNAME: ${ROOT_USER_LASTNAME:-Root}
      ROOT_USER_PHONE: ${ROOT_USER_PHONE:-+257 69 65 75 54}
      
      # Configuration SMTP (optionnel en dev)
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_SECURE: ${SMTP_SECURE:-false}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      SMTP_FROM: ${SMTP_FROM:-noreply@ruzizihotel.com}
      
      # URL du frontend
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      
      # Clés JWT
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-key}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      
    ports:
      - "${APP_PORT:-3000}:3000"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.next
      - app_dev_uploads:/app/uploads
    networks:
      - ruzizi-dev-network
    depends_on:
      mongodb-dev:
        condition: service_healthy
        required: false
    profiles:
      - development

  # Redis pour le développement
  redis-dev:
    image: redis:7-alpine
    container_name: ruzizi-redis-dev
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_dev_data:/data
    networks:
      - ruzizi-dev-network
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis123}

# Volumes pour développement
volumes:
  mongodb_dev_data:
    driver: local
  mongodb_dev_config:
    driver: local
  redis_dev_data:
    driver: local
  app_dev_uploads:
    driver: local

# Réseau de développement
networks:
  ruzizi-dev-network:
    driver: bridge