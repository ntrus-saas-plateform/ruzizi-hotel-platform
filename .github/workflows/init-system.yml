name: Initialisation du Syst√®me

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement cible'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      force_recreate:
        description: 'Forcer la recr√©ation de l\'utilisateur root'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18.x'

jobs:
  init-system:
    name: Initialisation du Syst√®me
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üîß Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Installation des d√©pendances
        run: npm ci

      - name: üèóÔ∏è Build du script d'initialisation
        run: npx tsc scripts/init-root-user.ts --outDir dist --target es2020 --module commonjs --esModuleInterop --resolveJsonModule

      - name: üîê Initialisation de l'utilisateur root
        run: node dist/scripts/init-root-user.js
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          ROOT_USER_EMAIL: ${{ secrets.ROOT_USER_EMAIL }}
          ROOT_USER_FIRSTNAME: ${{ secrets.ROOT_USER_FIRSTNAME }}
          ROOT_USER_LASTNAME: ${{ secrets.ROOT_USER_LASTNAME }}
          ROOT_USER_PHONE: ${{ secrets.ROOT_USER_PHONE }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_SECURE: ${{ secrets.SMTP_SECURE }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          FORCE_RECREATE: ${{ github.event.inputs.force_recreate }}

      - name: üìä Rapport d'initialisation
        run: |
          echo "‚úÖ Initialisation termin√©e avec succ√®s"
          echo "Environnement: ${{ github.event.inputs.environment }}"
          echo "Utilisateur root: ${{ secrets.ROOT_USER_EMAIL }}"
          echo "Force recreate: ${{ github.event.inputs.force_recreate }}"

      - name: üìß Notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Initialisation du syst√®me Ruzizi H√¥tel
            Environnement: ${{ github.event.inputs.environment }}
            Statut: ${{ job.status }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}